<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth" style="background-color: var(--background-color);">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pointer - Generate Game Sprites with AI</title>
    <meta name="description" content="Transform photos into game-ready character sprites using OpenAI's GPT-Image-1 model">
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <!-- Open Graph / Social Media Metadata -->
    <meta property="og:title" content="Pointer - Generate Game Sprites with AI">
    <meta property="og:description" content="Transform photos into game-ready character sprites using OpenAI's GPT-Image-1 model">
    <meta property="og:image" content="https://marcelontime.github.io/spriteforge/media/spriteforge.png">
    <meta property="og:url" content="https://marcelontime.github.io/spriteforge">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <!-- WhatsApp specific -->
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:image:alt" content="Pointer - Generate Game Sprites with AI">
    <meta property="og:image:type" content="image/png">
    <meta property="og:site_name" content="Pointer">
    <meta name="thumbnail" content="https://marcelontime.github.io/spriteforge/media/spriteforge.png">
    <meta itemprop="image" content="https://marcelontime.github.io/spriteforge/media/spriteforge.png">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="styles/output.css">
    <link rel="stylesheet" href="styles/main.css">
    <!-- Simple initialization script -->
    <script>
      // Initialize with clean step handling
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing wizard');
      });
    </script>
    <style>
      body {
        background: #ffffff;
        color: #1f2937;
      }
      
      .step-circle {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: var(--text-muted);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }
      
      .step-circle.active {
        color: white;
        border-color: var(--primary-color);
      }
      
      .step-circle.completed {
        color: var(--primary-color);
        border-color: var(--primary-color);
      }
      
      .step-line {
        flex-grow: 1;
        height: 2px;
        background-color: var(--border-color);
        margin: 0 8px;
      }
      
      .step-line.active {
        background-color: var(--primary-color);
      }
      
      .style-card {
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
        background-color: var(--background-color);
        overflow: hidden;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 100%;
      }
      
      .style-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .style-card.selected, .style-option.selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
      }
      
      /* Simple Step Panel Visibility Control */
      .step-panel {
        display: none;
      }
      
      .step-panel.is-active {
        display: block;
      }
      
      /* Custom animations */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
      
      /* Image preview styles */
      #imagePreview {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 1rem 0;
      }
      
      #imagePreview.hidden {
        display: none;
      }
      
      #previewImage {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        object-fit: contain;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      
      #previewImage:hover {
        transform: scale(1.05);
      }
      
      :root {
        --primary-color: #007acc;
        --primary-rgb: 0, 122, 204;
        --secondary-color: #6c757d;
        --secondary-rgb: 108, 117, 125;
        --background-color: #ffffff;
        --surface-color: #f8f9fa;
        --border-color: #e9ecef;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
      }
      
      /* Button Styles */
      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        font-weight: 500;
        border-radius: 0.25rem;
        border: 1px solid var(--primary-color);
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .btn-primary:hover {
        background-color: #0066a3;
        border-color: #0066a3;
        transform: translateY(-1px);
      }
      
      .btn-primary:disabled {
        background-color: var(--text-muted);
        border-color: var(--text-muted);
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-secondary {
        background-color: var(--surface-color);
        color: var(--text-primary);
        font-weight: 500;
        border-radius: 0.25rem;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .btn-secondary:hover {
        background-color: #e2e8f0;
        border-color: var(--secondary-color);
      }
      
      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: border-color 0.2s;
      }
      
      .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
      }
      
      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }
      
      /* Style Grid */
      .style-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
        min-height: 200px;
      }
      
      /* Selection Summary Styles */
      .selection-summary {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      
      .selection-summary-item {
        position: relative;
        transition: transform 0.2s ease;
      }
      
      .selection-summary-item:hover {
        transform: translateY(-1px);
      }
      
      .selection-summary-image {
        width: 100px;
        height: 100px;
        border-radius: 0.25rem;
        overflow: hidden;
        background-color: var(--background-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }
      
      .selection-summary-image img {
        object-fit: contain;
        width: 100%;
        height: 100%;
      }
      
      .selection-summary-image.uploaded {
        border-color: rgba(var(--primary-rgb), 0.5);
      }
      
      .selection-summary-image.selected {
        border-color: rgba(var(--secondary-rgb), 0.5);
      }

      /* Chat Sidebar Styles */
      .chat-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: 400px;
        background: var(--surface-color);
        border-left: 1px solid var(--border-color);
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      }

      .chat-sidebar.open {
        transform: translateX(0);
      }

      .chat-toggle {
        position: fixed;
        top: 20px;
        right: 420px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        z-index: 1001;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .chat-toggle:hover {
        background: #0066a3;
        transform: scale(1.05);
      }

      .chat-sidebar:not(.open) + .chat-toggle {
        right: 20px;
      }

      .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-color);
      }

      .chat-messages {
        flex: 1;
        font-size: 12px;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .chat-message {
        max-width: 80%;
        word-wrap: break-word;
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .chat-message.user {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 1rem 1rem 0.25rem 1rem;
        font-weight: 500;
      }

      .chat-message.ai {
        align-self: flex-start;
        background: var(--background-color);
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        border-radius: 1rem 1rem 1rem 0.25rem;
        border: 1px solid var(--border-color);
      }

      .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        background: var(--background-color);
      }

      .chat-input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 0.75rem 1rem;
        color: var(--text-primary);
        resize: none;
        min-height: 40px;
        max-height: 120px;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
      }

      .chat-send-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: bold;
      }

      .chat-send-btn:hover:not(:disabled) {
        background: #0066a3;
        transform: scale(1.05);
      }

      .chat-send-btn:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
      }

      .typing-indicator {
        align-self: flex-start;
        background: var(--surface-color);
        color: var(--text-secondary);
        padding: 0.75rem 1rem;
        border-radius: 1rem 1rem 1rem 0.25rem;
        border: 1px solid var(--border-color);
        font-style: italic;
        display: none;
        font-size: 12px;
        margin-bottom:10px;
        margin-left:10px;
      }

      .typing-indicator.show {
        display: block;
      }

      /* Responsive adjustments */
      @media (max-width: 640px) {
        .chat-sidebar {
          width: 100vw;
        }
        
        .chat-sidebar.open + .chat-toggle {
          right: 20px;
        }
      }

      /* Ensure main content doesn't get covered */
      body.chat-open {
        margin-right: 0;
      }

      @media (min-width: 1024px) {
        body.chat-open .container {
          margin-right: 420px;
          transition: margin-right 0.3s ease-in-out;
        }
      }

      @media (min-width: 768px) and (max-width: 1023px) {
        body.chat-open .container {
          margin-right: 420px;
          transition: margin-right 0.3s ease-in-out;
        }
      }

      /* Navigation Header Styles */
      .navbar {
        position: sticky;
        top: 0;
        z-index: 999;
        background-color: var(--background-color);
        border-bottom: 1px solid var(--border-color);
        backdrop-filter: blur(8px);
      }

      .navbar-brand {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .navbar-brand:hover {
        color: var(--primary-color);
        transform: translateY(-1px);
      }

      .navbar-brand::before {
        content: "‚óè";
        color: var(--primary-color);
        font-size: 1.25rem;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
    </style>
  </head>
  <body class="h-full antialiased chat-open" style="color: var(--text-primary);">
    <!-- Helper functions -->
    <script>
      // showImageModal function removed as requested
      
      // API key is loaded from environment configuration in state.js
      // No need to manually load from localStorage
    </script>
    
    <!-- Navigation Header -->
    <nav class="navbar">
      <div class="container mx-auto px-4 py-3 flex items-center justify-between max-w-5xl">
        <a href="#" class="navbar-brand" onclick="window.location.reload()">
          Pointer
        </a>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl" style="background-color: var(--background-color);">
      <!-- Main header -->
      <header class="text-center mb-12 pt-4">
        <h1 class="text-4xl sm:text-6xl font-extrabold mb-6" style="color: var(--text-primary);">
          Turn character descriptions into<br />
          <span style="color: var(--primary-color);">game-ready sprites</span>
        </h1>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <!-- Buttons removed -->
        </div>
      </header>
      
      <!-- Step indicator - progression tracker -->
      <div class="flex items-center justify-center mb-12 max-w-sm mx-auto" id="stepper">
        <div class="step flex items-center" data-step="1">
          <div class="step-circle active flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium">1</div>
          <div class="ml-2 mr-auto text-sm font-medium" style="color: var(--primary-color);">Describe</div>
        </div>
        
        <div class="h-0.5 w-20 mx-3 step-line"></div>
        
        <div class="step flex items-center" data-step="2">
          <div class="step-circle flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium">2</div>
          <div class="ml-2 text-sm font-medium" style="color: var(--text-muted);">Actions</div>
        </div>
      </div>
      
      <!-- Main content -->
      <main class="relative">
        <!-- STEP 1 ‚Äì Describe -->
        <section data-step="1" class="step-panel is-active" id="describe">
          <!-- Top action navigation -->
          <div class="flex items-center justify-between mb-8">
            <!-- Buttons removed -->
          </div>
          
          <!-- Character Generation Placeholder -->
          <div class="flex justify-center mb-6 p-20" id="placeholderBox">
            <div class="w-half max-w-2xl p-20">
              <div class="rounded-lg p-20 flex flex-col items-center justify-center min-h-[400px]" style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
                <div class="text-center w-half p-20">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mb-8 mx-auto" style="color: var(--text-muted); padding-top:20px;" fill="none" width="50px" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                  
                  <div class="text-3xl font-medium mb-6" style="color: var(--text-muted);">
                    Generate your character
              </div>
              
                  <p class="text-base" style="color: var(--text-secondary);padding:20px">
                    Use the AI Assistant to describe your character and generate sprites
                  </p>
            </div>
              </div>
            </div>
          </div>
          
          <!-- API Key (hidden - loaded from environment) -->
          <div class="mb-8" style="display: none;">
            <form id="apiKeyForm" onsubmit="event.preventDefault();" autocomplete="off">
              <input type="text" id="apiUsername" name="username" style="display: none;" autocomplete="username" value="openai" />
              <label for="apiKey" class="form-label">OpenAI API Key</label>
              <input type="password" id="apiKey" name="apiKey" class="form-input" placeholder="sk-..." autocomplete="new-password" data-lpignore="true" />
            </form>
          </div>
          

          
          <!-- Navigation -->
          <div class="flex justify-center">
            <button id="toStep2" class="btn-primary px-8 py-3">Continue to Actions ‚Üí</button>
          </div>
        </section>
        
        <!-- STEP 2 ‚Äì Style - Skip this in the new interface -->
        <section data-step="2" class="step-panel" id="style">
          <!-- Top action navigation -->
          <div class="flex items-center justify-between mb-8">
            <button type="button" class="btn-secondary px-6 py-3 rounded-md" data-back="1">‚Üê Back to Upload</button>
          </div>
          
          <!-- Selected Style Preview and Image -->
          <div class="flex flex-col md:flex-row gap-6 mb-6">
            <!-- Left side - Styled Image Preview -->
            <div class="w-full md:w-1/2 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]" style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
              <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Generated Style</h3>
              <div id="styledImageContainer" class="w-full flex items-center justify-center">
                <img id="styledImagePreview" class="max-h-48 max-w-full rounded shadow object-contain" alt="Styled Preview" />
              </div>
            </div>
            
            <!-- Right side - Action Selection -->
            <div class="w-full md:w-1/2 rounded-lg p-4 flex flex-col" style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
              <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Choose Action</h3>
              
              <!-- Action selection dropdown -->
              <div class="mb-4">
                <label for="actionSelect" class="form-label">Animation Type</label>
                <select id="actionSelect" class="form-input">
                  <option value="" disabled selected>Select action...</option>
                  <!-- Options will be populated from ACTION_PROMPTS -->
                </select>
              </div>
              
              <!-- Action description will be shown here -->
              <div id="actionDescription" class="text-sm mb-4" style="color: var(--text-secondary);">
                Select an action to see its description and frame count.
              </div>
              
              <!-- Generate button -->
              <button id="generateActionBtn" class="btn-primary w-full py-3 mt-auto" disabled>
                Generate Action
              </button>
            </div>
          </div>
          
          <!-- Animation Preview Section - Simplified -->
          <div class="rounded-lg p-6 mb-8" style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Action Preview</h3>
            
            <!-- Preview Area -->
            <div id="actionPreview" class="flex justify-center items-center min-h-[200px] rounded-lg mb-4 hidden" style="background-color: var(--background-color);">
              <!-- Preview content will be inserted here -->
            </div>
            
            <!-- Generated Frames Grid -->
            <div id="actionFramesContainer" class="mt-4">
              <!-- Frame grid will be inserted here -->
            </div>
          </div>
        </section>
      </main>
      
      <!-- Footer -->
      <footer class="text-center text-sm mt-16 pb-8" style="color: var(--text-muted);">
        Built by the team &nbsp;¬∑&nbsp; <a href="https://github.com/marcelontime/spriteforge" class="underline hover:opacity-70" style="color: var(--text-muted);">GitHub</a>
      </footer>
    </div>
    
    <!-- Image Modal removed as requested -->
    
    <!-- Chat Sidebar -->
    <div id="chatSidebar" class="chat-sidebar open">
      <div class="chat-header">
        <h3 class="text-lg font-semibold" style="color: var(--text-primary);">AI Assistant</h3>
        <p class="text-sm" style="color: var(--text-secondary);">Ask me anything about sprite generation!</p>
      </div>
      
      <div id="chatMessages" class="chat-messages">
        <div class="chat-message ai">
          <div>Welcome to Pointer! I'm here to help you create amazing game sprites from character descriptions.

To get started, describe your character in detail. The more specific you are, the better your sprite will be! Here are some examples:

‚Ä¢ A brave knight in shining armor with a blue cape and golden sword
‚Ä¢ A mystical forest elf with emerald robes, pointed ears, and a magical bow
‚Ä¢ A cyberpunk hacker with neon-lit goggles, dark clothing, and glowing tattoos
‚Ä¢ A friendly dragon with colorful scales, small wings, and a cheerful expression

Tell me about your character's appearance, clothing, accessories, and style. What kind of sprite would you like to create?</div>
        </div>
      </div>
      
      <div class="typing-indicator" id="typingIndicator">
        Thinking...
      </div>
      
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea 
            id="chatInput" 
            class="chat-input" 
            placeholder="Type your message..."
            rows="1"
          ></textarea>
          <button id="chatSendBtn" class="chat-send-btn" title="Send message">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Chat Toggle Button -->
    <button id="chatToggle" class="chat-toggle" title="Toggle AI Assistant">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
    </button>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/state.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/chatRouter.js"></script>
    <script type="module" src="js/ui.js"></script>
    <script type="module" src="js/wizard.js"></script>
    <script>
      // Basic event handlers
      document.addEventListener('DOMContentLoaded', function() {
        // Modal functionality removed as requested
        
        // API key is now loaded from environment configuration
        // No need for input handling since key is loaded from .env.local
        
        // Character generation is now handled through AI chat
        // No form validation needed for the placeholder box
        
        // Chat functionality
        initializeChat();
      });
      
      // Chat functionality
      function initializeChat() {
        const chatToggle = document.getElementById('chatToggle');
        const chatSidebar = document.getElementById('chatSidebar');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // Load chat history from localStorage
        loadChatHistory();
        
        // Toggle chat sidebar
        chatToggle.addEventListener('click', function() {
          const isOpen = chatSidebar.classList.contains('open');
          if (isOpen) {
            chatSidebar.classList.remove('open');
            document.body.classList.remove('chat-open');
          } else {
            chatSidebar.classList.add('open');
            document.body.classList.add('chat-open');
            // Focus on input when opened
            setTimeout(() => chatInput.focus(), 300);
          }
        });
        
        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          
          // Enable/disable send button
          chatSendBtn.disabled = !this.value.trim();
        });
        
        // Send message on Enter (without Shift)
        chatInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        // Send message on button click
        chatSendBtn.addEventListener('click', sendMessage);
        
        async function sendMessage() {
          const message = chatInput.value.trim();
          if (!message) return;
          
          console.log('üì® Sending message:', message);
          
          // Add user message
          addMessage(message, 'user');
          
          // Clear input
          chatInput.value = '';
          chatInput.style.height = 'auto';
          chatSendBtn.disabled = true;
          
          // Show typing indicator
          showTypingIndicator();
          
          try {
            // Generate AI response using the new routing system
            console.log('ü§ñ Generating AI response with routing...');
            const aiResponse = await generateAIResponse(message);
            console.log('‚úÖ AI response generated:', aiResponse);
            
            hideTypingIndicator();
            addMessage(aiResponse, 'ai');
          } catch (error) {
            console.error('‚ùå Error generating AI response:', error);
            hideTypingIndicator();
            addMessage("I apologize, but I encountered an error processing your request. Please try again.", 'ai');
          }
        }
        
        function addMessage(text, sender) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `chat-message ${sender}`;
          messageDiv.innerHTML = `<div>${escapeHtml(text)}</div>`;
          
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // Save to localStorage
          saveChatHistory();
        }
        
        function showTypingIndicator() {
          typingIndicator.classList.add('show');
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
          typingIndicator.classList.remove('show');
        }
        
        async function generateAIResponse(userMessage) {
          console.log('üéØ generateAIResponse called with message:', userMessage);
          
          try {
            // Check what step we're currently on
            const currentStep = getCurrentStep();
            console.log('üìç Current step:', currentStep);
            
            // If on step 1, bypass routing and generate character with DALL-E 3
            if (currentStep === 1) {
              console.log('üé® Step 1 detected - bypassing routing, generating character with DALL-E 3');
              return await handleStep1CharacterGeneration(userMessage);
            }
            
            // For other steps, use the normal routing system
            const { routeUserMessage } = await import('./js/chatRouter.js');
            
            // Route the message and get the category
            console.log('üîÄ Routing user message through chatRouter');
            const category = await routeUserMessage(userMessage);
            console.log('üìã Routing completed, category:', category);
            
            // Generate response based on the routed category
            return generateCategoryResponse(category, userMessage);
          } catch (error) {
            console.error('‚ùå Error in generateAIResponse:', error);
            return "I apologize, but I encountered an error processing your request. Please try again or check the console for more details.";
          }
        }
        
        /**
         * Determines the current step the user is on
         * @returns {number} - Current step number (1 or 2)
         */
        function getCurrentStep() {
          // Check which step panel has the 'is-active' class
          const activeStepPanel = document.querySelector('.step-panel.is-active');
          if (activeStepPanel) {
            const stepAttr = activeStepPanel.getAttribute('data-step');
            return parseInt(stepAttr) || 1;
          }
          
          // Fallback: check step indicator
          const activeStepCircle = document.querySelector('.step-circle.active');
          if (activeStepCircle) {
            const parentStep = activeStepCircle.closest('[data-step]');
            if (parentStep) {
              return parseInt(parentStep.getAttribute('data-step')) || 1;
            }
          }
          
          // Default to step 1
          return 1;
        }
        
        /**
         * Handles character generation for step 1 using DALL-E 3
         * @param {string} userMessage - The user's character description
         * @returns {Promise<string>} - Response message
         */
        async function handleStep1CharacterGeneration(userMessage) {
          console.log('üé® Starting DALL-E 3 character generation');
          console.log('üìù User prompt:', userMessage);
          
          try {
            // Import the DALL-E 3 function
            const { callDALLE3 } = await import('./js/api.js');
            
            // Enhance the user's prompt for better sprite generation
            const enhancedPrompt = `Generate an image of a video game character sprite with a solid white background. The details of the character: ${userMessage}. The character should be suitable for a 2D game, with clear details and vibrant colors. Style: digital art, game sprite, clean design. Generate just a SINGLE character with no other background and no other elements.
            GENERATE A SINGLE CHARACTER. ONE CHARACTER. ONE. ONE CHARACTER ONLY. NOTHING ELSE.`;
            
            console.log('üîÑ Enhanced prompt:', enhancedPrompt);
            
            // Call DALL-E 3 to generate the character
            console.log('üì° Calling DALL-E 3...');
            const imageUrl = await callDALLE3(enhancedPrompt);
            console.log('‚úÖ DALL-E 3 generation complete');
            
            // Replace the placeholder box with the generated image
            replaceCharacterPlaceholder(imageUrl);
            
            // Enable the continue button
            enableContinueButton();
            
            return "Perfect! I've generated your character using DALL-E 3. You can see the result in the main panel above. When you're ready, click 'Continue to Actions ‚Üí' to proceed to the animation step.";
            
          } catch (error) {
            console.error('‚ùå Error in DALL-E 3 character generation:', error);
            return `Sorry, I encountered an error generating your character: ${error.message}. Please try again with a different description.`;
          }
        }
        
        /**
         * Replaces the character placeholder box with the generated image
         * @param {string} imageUrl - Data URL of the generated image
         */
        function replaceCharacterPlaceholder(imageUrl) {
          console.log('üñºÔ∏è Replacing placeholder with generated image');
          
          const placeholderContainer = document.getElementById('placeholderBox');
          if (placeholderContainer) {
            placeholderContainer.innerHTML = `
              <div class="w-half max-w-2xl p-20">
                <div class="rounded-lg p-8 flex flex-col items-center justify-center" style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
                  <div class="text-center mb-4">
                    <h3 class="text-2xl font-medium mb-2" style="color: var(--text-primary);">Your Generated Character</h3>
                    <p class="text-sm" style="color: var(--text-secondary);">Character created with DALL-E 3</p>
                  </div>
                  
                  <!-- Top Continue Button -->
                  <div class="w-full flex justify-center mb-6">
                    ${createContinueButton('continueBtn-top', 'btn-primary px-8 py-3 opacity-50 cursor-not-allowed')}
                  </div>
                  
                  <!-- Generated Character Image -->
                  <div class="bg-white rounded-lg p-4 shadow-lg">
                    <img src="${imageUrl}" 
                         alt="Generated Character" 
                         style="width: 200px; height: 200px;"
                         class="w-[200px] h-[200px] object-contain rounded" />
                  </div>
                  
                  <!-- Bottom Continue Button -->
                  <div class="text-center mt-6">
                    <p class="text-sm mb-4" style="color: var(--text-secondary);">
                      Ready to add animations and actions to your character?
                    </p>
                    ${createContinueButton('continueBtn-bottom', 'btn-primary px-8 py-3 opacity-50 cursor-not-allowed')}
                  </div>
                </div>
              </div>
            `;
            console.log('‚úÖ Placeholder replaced successfully with dual continue buttons');
          } else {
            console.error('‚ùå Could not find placeholder container');
          }
        }
        
        /**
         * Creates a reusable continue button component
         * @param {string} id - Unique ID for the button
         * @param {string} classes - Additional CSS classes
         * @returns {string} - HTML string for the button
         */
        function createContinueButton(id = 'continueBtn', classes = 'btn-primary px-8 py-3') {
          return `<button id="${id}" class="${classes}" onclick="handleContinueToActions()">Continue to Actions ‚Üí</button>`;
        }

        /**
         * Handles the continue to actions functionality
         */
        function handleContinueToActions() {
          console.log('üöÄ Continue to Actions clicked');
          // Add your step 2 navigation logic here
          // For now, just show a message
          console.log('Proceeding to step 2...');
          
          // You can add actual step navigation here
          // Example: goToStep(2) if that function exists
        }

        /**
         * Enables all continue buttons for proceeding to step 2
         */
        function enableContinueButton() {
          const continueButtons = document.querySelectorAll('[id*="continueBtn"], #toStep2');
          continueButtons.forEach(btn => {
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
          });
          console.log('‚úÖ Continue buttons enabled');
        }
        
        function generateCategoryResponse(category, originalMessage) {
          console.log('üí¨ Generating response for category:', category);
          
          switch (category) {
            case 'character':
              return "I can help you create a character sprite! Based on your description, I'll generate a unique character using DALL-E 3. Please provide more details about your character's appearance, clothing, and style, and I'll create a sprite for you.";
              
            case 'idle':
              return "Great! I can generate an idle animation for your character. This will create a 4-frame breathing animation that shows your character in a natural standing pose. The animation will be ready for use in your game.";
              
            case 'walk':
              return "Perfect! I can create a walking animation cycle for your character. This will be a smooth 12-frame animation showing natural walking movement with proper arm and leg coordination.";
              
            case 'jump':
              return "Excellent! I can generate a jumping animation for your character. This will be a 4-frame sequence showing the crouch, launch, peak, and landing phases of a jump.";
              
            case 'air_attack':
              return "Nice! I can create an air attack animation for your character. This will be a 2-frame aerial combat move that shows your character executing a powerful mid-air strike.";
              
            case 'hurt':
              return "I can generate a hurt animation for your character. This will be a 2-frame reaction animation showing your character taking damage and recoiling from impact.";
              
            case 'knock_out':
              return "I can create a knockout animation for your character. This will be a 6-frame dramatic sequence showing your character being defeated and falling to the ground.";
              
            case 'punches':
              return "Great choice! I can generate a punch combination animation for your character. This will be an 8-frame sequence showing various punch attacks including jabs, hooks, and uppercuts.";
              
            case 'turn_around':
              return "I can create a turn around animation for your character. This will be a 3-frame sequence showing your character smoothly changing direction with a 180-degree turn.";
              
            case 'unknown':
            default:
              return "I'm here to help with sprite generation! You can:\n‚Ä¢ Describe a character you want me to create\n‚Ä¢ Ask for specific animations like 'walking', 'jumping', 'punching'\n‚Ä¢ Request help with art styles or game sprite creation\n\nWhat would you like to work on?";
          }
        }
        
        function saveChatHistory() {
          const messages = [];
          chatMessages.querySelectorAll('.chat-message').forEach(msg => {
            const isUser = msg.classList.contains('user');
            const text = msg.querySelector('div').textContent;
            messages.push({ text, sender: isUser ? 'user' : 'ai' });
          });
          localStorage.setItem('spriteforge_chat_history', JSON.stringify(messages));
        }
        
        function loadChatHistory() {
          const history = localStorage.getItem('spriteforge_chat_history');
          if (history) {
            const messages = JSON.parse(history);
            // Clear existing messages except the welcome message
            const welcomeMessage = chatMessages.querySelector('.chat-message.ai');
            chatMessages.innerHTML = '';
            if (welcomeMessage) {
              chatMessages.appendChild(welcomeMessage);
            }
            
            // Add saved messages
            messages.forEach(msg => {
              if (msg.text && msg.sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.sender}`;
                messageDiv.innerHTML = `<div>${escapeHtml(msg.text)}</div>`;
                chatMessages.appendChild(messageDiv);
              }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
        
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }
    </script>
  </body>
</html> 